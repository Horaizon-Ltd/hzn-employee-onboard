name: Deploy to Dev

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pages: write

jobs:
  build-images:
    name: Build Lambda Docker Image
    runs-on: ubuntu-latest
    outputs:
      changes-detected: ${{ steps.detect.outputs.changes_detected }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect Lambda changes
        id: detect
        uses: dorny/paths-filter@v3
        with:
          filters: |
            changes_detected:
              - "aws-source/handlers_docker/generate_output/**"
              - "!aws-source/handlers_docker/generate_output/tests/**"

      - name: Log change detection
        run: |
          if [ "${{ steps.detect.outputs.changes_detected }}" == "true" ]; then
            echo "Changes detected in Lambda handler - will build Docker image"
          else
            echo "No changes detected - skipping Docker build"
          fi

      - name: Build Docker Image
        if: steps.detect.outputs.changes_detected == 'true'
        uses: ./.github/actions/docker-build
        with:
          handler_name: generate_output

      - name: Save Docker Image as Artifact
        if: steps.detect.outputs.changes_detected == 'true'
        run: |
          docker save generate_output-ecr-repo:latest | gzip > generate_output.tar.gz

      - name: Upload Docker Image Artifact
        if: steps.detect.outputs.changes_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generate_output-image
          path: generate_output.tar.gz
          retention-days: 1

  push-dev-ecr:
    name: Push to Dev ECR
    runs-on: ubuntu-latest
    environment: "dev"
    needs: [build-images]
    if: needs.build-images.outputs.changes-detected == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Docker Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: generate_output-image

      - name: Load Docker Image
        run: |
          docker load < generate_output.tar.gz

      - name: Push to Dev ECR
        uses: ./.github/actions/docker-push
        with:
          handler_name: generate_output
          environment: "dev"
          aws_region: ${{ secrets.AWS_REGION }}
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}

  deploy-dev:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    environment: "dev"
    needs: [push-dev-ecr]
    if: always() && (needs.push-dev-ecr.result == 'success' || needs.push-dev-ecr.result == 'skipped')
    env:
      TF_CLI_ARGS: "-input=false"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup deployment
        uses: ./.github/actions/setup-deployment
        with:
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_region: ${{ secrets.AWS_REGION }}

      - name: Deploy with Terraform
        uses: ./.github/actions/deploy
        with:
          environment: "dev"
          aws_account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          aws_region: ${{ secrets.AWS_REGION }}

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build React app
        working-directory: ./frontend
        env:
          REACT_APP_USER_POOL_ID: ${{ secrets.REACT_APP_USER_POOL_ID }}
          REACT_APP_USER_POOL_CLIENT_ID: ${{ secrets.REACT_APP_USER_POOL_CLIENT_ID }}
          REACT_APP_LAMBDA_URL: ${{ secrets.REACT_APP_LAMBDA_URL }}
          REACT_APP_UPLOAD_URL: ${{ secrets.REACT_APP_UPLOAD_URL }}
        run: npm run build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./frontend/build
          retention-days: 1

  publish-frontend:
    name: Publish to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: deploy-frontend
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
